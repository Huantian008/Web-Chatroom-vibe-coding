// ===== å¼•å…¥Node.jså†…ç½®æ¨¡å— =====

// fsï¼ˆFile Systemï¼‰ï¼šæ–‡ä»¶ç³»ç»Ÿæ¨¡å—ï¼Œç”¨äºè¯»å–å’Œç›‘å¬æ–‡ä»¶
const fs = require('fs');

// pathï¼šè·¯å¾„æ¨¡å—ï¼Œç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„
const path = require('path');

// ===== å®šä¹‰ç®¡ç†å‘˜é…ç½®æ–‡ä»¶çš„è·¯å¾„ =====
// __dirnameï¼šå½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•
// path.join()ï¼šæ‹¼æ¥è·¯å¾„ï¼Œç”Ÿæˆå®Œæ•´çš„æ–‡ä»¶è·¯å¾„
// æœ€ç»ˆè·¯å¾„ï¼šbackend/config/admins.json
const ADMIN_CONFIG_PATH = path.join(__dirname, '../config/admins.json');

// ===== å®šä¹‰ç®¡ç†å‘˜è¾…åŠ©ç±» =====
// è¿™æ˜¯ä¸€ä¸ªç±»ï¼ˆClassï¼‰ï¼Œç”¨äºç®¡ç†ç®¡ç†å‘˜åå•
// ç±»å°±åƒæ˜¯ä¸€ä¸ª"æ¨¡æ¿"ï¼Œå¯ä»¥åˆ›å»ºå¯¹è±¡å¹¶æä¾›ç›¸å…³åŠŸèƒ½
class AdminHelper {
    // ===== æ„é€ å‡½æ•° =====
    // constructor() æ˜¯ç±»çš„æ„é€ å‡½æ•°ï¼Œåˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨æ‰§è¡Œ
    constructor() {
        // this.adminsï¼šå­˜å‚¨ç®¡ç†å‘˜åå•çš„é›†åˆï¼ˆSetï¼‰
        // Set æ˜¯ JavaScript çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼æ•°ç»„ä½†å…ƒç´ ä¸é‡å¤
        // ä¾‹å¦‚ï¼šSet(['admin', 'Ruence'])
        this.admins = new Set();

        // this.watcherï¼šæ–‡ä»¶ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬é…ç½®æ–‡ä»¶çš„å˜åŒ–
        this.watcher = null;

        // åŠ è½½ç®¡ç†å‘˜åå•ï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ï¼‰
        this.loadAdmins();

        // å¼€å§‹ç›‘å¬é…ç½®æ–‡ä»¶ï¼ˆå½“æ–‡ä»¶ä¿®æ”¹æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰
        this.watchAdminFile();
    }

    // ===== åŠ è½½ç®¡ç†å‘˜åå•çš„æ–¹æ³• =====
    // ä» admins.json æ–‡ä»¶ä¸­è¯»å–ç®¡ç†å‘˜åå•
    loadAdmins() {
        // try-catchï¼šé”™è¯¯å¤„ç†
        try {
            // ===== è¯»å–é…ç½®æ–‡ä»¶ =====
            // fs.readFileSync()ï¼šåŒæ­¥è¯»å–æ–‡ä»¶ï¼ˆç¨‹åºä¼šç­‰å¾…è¯»å–å®Œæˆï¼‰
            // å‚æ•°1ï¼šæ–‡ä»¶è·¯å¾„
            // å‚æ•°2ï¼šç¼–ç æ ¼å¼ï¼ˆ'utf8' è¡¨ç¤ºä»¥æ–‡æœ¬æ ¼å¼è¯»å–ï¼‰
            // è¿”å›ï¼šæ–‡ä»¶å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰
            const data = fs.readFileSync(ADMIN_CONFIG_PATH, 'utf8');

            // ===== è§£æ JSON æ•°æ® =====
            // JSON.parse()ï¼šå°† JSON å­—ç¬¦ä¸²è½¬æ¢ä¸º JavaScript å¯¹è±¡
            // ä¾‹å¦‚ï¼š'{"admins": ["admin", "Ruence"]}' -> { admins: ['admin', 'Ruence'] }
            const config = JSON.parse(data);

            // ===== å°†ç®¡ç†å‘˜åå•å­˜å…¥ Set =====
            // config.adminsï¼šä»é…ç½®å¯¹è±¡ä¸­è·å– admins æ•°ç»„
            // || []ï¼šå¦‚æœ config.admins ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºæ•°ç»„
            // new Set()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Set å¯¹è±¡ï¼Œè‡ªåŠ¨å»é‡
            this.admins = new Set(config.admins || []);

            // ===== æ‰“å°æ—¥å¿— =====
            // Array.from(this.admins)ï¼šå°† Set è½¬æ¢ä¸ºæ•°ç»„
            // .join(', ')ï¼šå°†æ•°ç»„å…ƒç´ ç”¨é€—å·è¿æ¥æˆå­—ç¬¦ä¸²
            // ä¾‹å¦‚ï¼š['admin', 'Ruence'] -> 'admin, Ruence'
            console.log(`âœ… Loaded ${this.admins.size} admin(s): ${Array.from(this.admins).join(', ')}`);

        } catch (error) {
            // ===== å¦‚æœè¯»å–æ–‡ä»¶å¤±è´¥ =====
            // å¯èƒ½çš„åŸå› ï¼šæ–‡ä»¶ä¸å­˜åœ¨ã€JSON æ ¼å¼é”™è¯¯ç­‰
            console.error('âŒ Error loading admin config:', error.message);

            // å¦‚æœå‡ºé”™ï¼Œä½¿ç”¨ç©ºçš„ç®¡ç†å‘˜åå•
            this.admins = new Set();
        }
    }

    // ===== æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜çš„æ–¹æ³• =====
    // å‚æ•° usernameï¼šè¦æ£€æŸ¥çš„ç”¨æˆ·å
    // è¿”å›å€¼ï¼štrueï¼ˆæ˜¯ç®¡ç†å‘˜ï¼‰æˆ– falseï¼ˆä¸æ˜¯ç®¡ç†å‘˜ï¼‰
    isAdmin(username) {
        // this.admins.has(username)ï¼šæ£€æŸ¥ Set ä¸­æ˜¯å¦åŒ…å«è¿™ä¸ªç”¨æˆ·å
        // ä¾‹å¦‚ï¼šthis.admins = Set(['admin', 'Ruence'])
        //      isAdmin('admin') -> true
        //      isAdmin('user123') -> false
        return this.admins.has(username);
    }

    // ===== è·å–ç®¡ç†å‘˜åå•çš„æ–¹æ³• =====
    // è¿”å›å€¼ï¼šç®¡ç†å‘˜åå•æ•°ç»„
    getAdminList() {
        // Array.from(this.admins)ï¼šå°† Set è½¬æ¢ä¸ºæ•°ç»„
        // ä¸ºä»€ä¹ˆè¦è½¬æ¢ï¼Ÿå› ä¸ºå¾ˆå¤š JavaScript æ“ä½œéœ€è¦æ•°ç»„æ ¼å¼
        return Array.from(this.admins);
    }

    // ===== é‡æ–°åŠ è½½ç®¡ç†å‘˜åå•çš„æ–¹æ³• =====
    // å½“é…ç½®æ–‡ä»¶ä¿®æ”¹åï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•é‡æ–°åŠ è½½
    reloadAdmins() {
        // ç›´æ¥è°ƒç”¨ loadAdmins() æ–¹æ³•
        this.loadAdmins();
    }

    // ===== ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–çš„æ–¹æ³• =====
    // å½“ admins.json æ–‡ä»¶è¢«ä¿®æ”¹æ—¶ï¼Œè‡ªåŠ¨é‡æ–°åŠ è½½ç®¡ç†å‘˜åå•
    // è¿™æ ·ç®¡ç†å‘˜å°±å¯ä»¥åœ¨ä¸é‡å¯æœåŠ¡å™¨çš„æƒ…å†µä¸‹ä¿®æ”¹ç®¡ç†å‘˜åå•
    watchAdminFile() {
        // ===== æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç›‘å¬ =====
        // å¦‚æœå·²ç»åœ¨ç›‘å¬ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤ç›‘å¬
        if (this.watcher) return;

        // try-catchï¼šé”™è¯¯å¤„ç†
        try {
            // ===== å¼€å§‹ç›‘å¬æ–‡ä»¶ =====
            // fs.watch()ï¼šç›‘å¬æ–‡ä»¶æˆ–ç›®å½•çš„å˜åŒ–
            // å‚æ•°1ï¼šè¦ç›‘å¬çš„æ–‡ä»¶è·¯å¾„
            // å‚æ•°2ï¼šå›è°ƒå‡½æ•°ï¼Œå½“æ–‡ä»¶å˜åŒ–æ—¶æ‰§è¡Œ
            this.watcher = fs.watch(ADMIN_CONFIG_PATH, (eventType) => {
                // eventTypeï¼šäº‹ä»¶ç±»å‹
                // 'change'ï¼šæ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹
                // 'rename'ï¼šæ–‡ä»¶è¢«é‡å‘½åæˆ–åˆ é™¤
                if (eventType === 'change') {
                    // ===== æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œé‡æ–°åŠ è½½ç®¡ç†å‘˜åå• =====
                    console.log('ğŸ”„ Admin config changed, reloading...');
                    this.reloadAdmins();
                }
            });

            // ===== å…è®¸è¿›ç¨‹é€€å‡ºï¼ˆå³ä½¿ç›‘å¬å™¨è¿˜åœ¨è¿è¡Œï¼‰ =====
            // this.watcher.unref()ï¼šè§£é™¤å¯¹è¿›ç¨‹çš„å¼•ç”¨
            // ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ
            // å¦‚æœä¸è°ƒç”¨ unref()ï¼ŒNode.js è¿›ç¨‹ä¼šä¸€ç›´ç­‰å¾…ç›‘å¬å™¨
            // è°ƒç”¨ unref() åï¼Œå¦‚æœåªå‰©ä¸‹ç›‘å¬å™¨åœ¨è¿è¡Œï¼Œè¿›ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º
            if (this.watcher?.unref) {
                this.watcher.unref();
            }

        } catch (error) {
            // ===== å¦‚æœç›‘å¬å¤±è´¥ =====
            console.error('âŒ Failed to watch admin config file:', error.message);
        }
    }
}

// ===== å¯¼å‡º AdminHelper çš„å•ä¾‹ =====
// new AdminHelper()ï¼šåˆ›å»ºä¸€ä¸ª AdminHelper å®ä¾‹
// module.exportsï¼šå¯¼å‡ºè¿™ä¸ªå®ä¾‹
// ä¸ºä»€ä¹ˆå¯¼å‡ºå®ä¾‹è€Œä¸æ˜¯ç±»ï¼Ÿ
// å› ä¸ºæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªç®¡ç†å‘˜è¾…åŠ©å¯¹è±¡ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
// è¿™æ ·æ•´ä¸ªåº”ç”¨ç¨‹åºå…±äº«åŒä¸€ä¸ªç®¡ç†å‘˜åå•å’Œç›‘å¬å™¨
module.exports = new AdminHelper();
