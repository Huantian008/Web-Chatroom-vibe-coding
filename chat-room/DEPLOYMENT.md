# Production Deployment Guide

## Prerequisites

- Docker and Docker Compose installed
- Domain name configured (optional)
- SSL certificate (recommended for production)

## Deployment Steps

### 1. Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Add user to docker group
sudo usermod -aG docker $USER
```

### 2. Project Setup

```bash
# Clone repository
git clone <your-repo-url>
cd chat-room

# Setup environment
cp .env.example .env

# Generate secure keys
openssl rand -base64 32
```

### 3. Configure .env

```bash
# Edit .env file
nano .env
```

Required configurations:
```env
# MongoDB
MONGO_USER=<strong_username>
MONGO_PASSWORD=<strong_password>
MONGO_DATABASE=chatroom

# Backend
NODE_ENV=production
JWT_SECRET=<generated_with_openssl>
PORT=3000

# AI Service
DEEPSEEK_API_KEY=<your_api_key>

# CORS (if using custom domain)
CORS_ORIGIN=https://your-domain.com
```

### 4. Deploy

```bash
# Build and start
make docker-up
# or
./docker-start.sh

# Check status
docker-compose ps
docker-compose logs -f
```

### 5. Setup Reverse Proxy (Nginx)

#### Install Nginx
```bash
sudo apt install nginx certbot python3-certbot-nginx -y
```

#### Configure Nginx

Create `/etc/nginx/sites-available/chatroom`:
```nginx
upstream backend {
    server localhost:3000;
}

upstream frontend {
    server localhost:8080;
}

server {
    listen 80;
    server_name your-domain.com;

    # Redirect to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL configuration (auto-generated by certbot)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Backend API
    location /api {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Socket.io
    location /socket.io {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### Enable site
```bash
sudo ln -s /etc/nginx/sites-available/chatroom /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### Setup SSL
```bash
sudo certbot --nginx -d your-domain.com
```

## Monitoring

### Health Checks

Create a monitoring script `monitor.sh`:
```bash
#!/bin/bash

check_health() {
    url=$1
    name=$2
    
    if curl -s -f "$url/health" > /dev/null; then
        echo "✅ $name is healthy"
        return 0
    else
        echo "❌ $name is down"
        return 1
    fi
}

echo "Health Check - $(date)"
check_health "http://localhost:3000" "Backend"
check_health "http://localhost:5000" "AI Service"
check_health "http://localhost:8080" "Frontend"
```

### Auto-restart (optional)

Create `/etc/systemd/system/chatroom.service`:
```ini
[Unit]
Description=Chat Room Application
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/path/to/chat-room
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

Enable:
```bash
sudo systemctl enable chatroom
sudo systemctl start chatroom
```

## Backup Strategy

### Automated Backups

Create `backup.sh`:
```bash
#!/bin/bash

BACKUP_DIR="/backups/chatroom"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup MongoDB
docker-compose exec -T mongodb mongodump --archive | gzip > $BACKUP_DIR/mongodb_$DATE.gz

# Backup environment files
cp .env $BACKUP_DIR/.env_$DATE

# Remove old backups
find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $BACKUP_DIR/mongodb_$DATE.gz"
```

Setup cron job:
```bash
# Edit crontab
crontab -e

# Add backup at 2 AM daily
0 2 * * * /path/to/chat-room/backup.sh >> /var/log/chatroom-backup.log 2>&1
```

## Scaling

### Using Docker Swarm

```bash
# Initialize swarm
docker swarm init

# Deploy stack
docker stack deploy -c docker-compose.yml chatroom

# Scale services
docker service scale chatroom_backend=3
docker service scale chatroom_frontend=2
```

### Load Balancing with Nginx

Update nginx upstream:
```nginx
upstream backend {
    least_conn;
    server backend-1:3000;
    server backend-2:3000;
    server backend-3:3000;
}
```

## Security Checklist

- [ ] Change default passwords
- [ ] Use strong JWT secret
- [ ] Enable HTTPS
- [ ] Configure CORS properly
- [ ] Setup firewall (ufw)
- [ ] Enable rate limiting
- [ ] Regular security updates
- [ ] Monitor logs
- [ ] Setup alerts for downtime
- [ ] Backup strategy in place
- [ ] Document recovery procedures

## Troubleshooting

### Container won't start
```bash
# Check logs
docker-compose logs <service>

# Check resource usage
docker stats

# Restart
docker-compose restart <service>
```

### Database connection failed
```bash
# Check MongoDB is running
docker-compose ps mongodb

# Test connection
docker-compose exec backend sh -c "node -e 'console.log(process.env.MONGODB_URI)'"

# Check logs
docker-compose logs mongodb
```

### Out of memory
```bash
# Check Docker resource limits
docker system df

# Clean up
docker system prune -a

# Adjust container limits in docker-compose.yml
```

## Performance Tuning

### MongoDB Optimization

Add to docker-compose.yml:
```yaml
mongodb:
  command: >
    mongod
    --wiredTigerCacheSizeGB 2
    --maxConns 1000
```

### Node.js Optimization

Add to backend/.env:
```env
NODE_OPTIONS=--max-old-space-size=2048
```

### Nginx Caching

Add to nginx config:
```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

location /api {
    proxy_cache api_cache;
    proxy_cache_valid 200 10m;
    proxy_cache_key "$scheme$request_method$host$request_uri";
    # ... other config
}
```
