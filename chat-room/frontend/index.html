<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="多频道实时聊天室">
    <title>Lumina Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Sora:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app" v-cloak>
        <transition name="fade" mode="out-in">
            <div v-if="!isLoggedIn" class="auth-screen" key="auth">
                <div class="auth-card">
                    <div class="brand-row">
                        <div class="brand-icon">LC</div>
                        <div>
                            <div class="brand-title">Lumina Chat</div>
                            <p class="brand-subtitle">登录或注册后开启对话</p>
                        </div>
                    </div>

                    <div class="auth-tabs">
                        <button class="auth-tab" :class="{ active: authMode === 'login' }" @click="authMode = 'login'">登录</button>
                        <button class="auth-tab" :class="{ active: authMode === 'register' }" @click="authMode = 'register'">注册</button>
                    </div>

                    <form v-if="authMode === 'login'" class="auth-form" @submit.prevent="handleLogin">
                        <label class="input-label">用户名</label>
                        <input class="text-input" type="text" v-model="username" required minlength="2" maxlength="20" autocomplete="username">

                        <label class="input-label">密码</label>
                        <input class="text-input" type="password" v-model="password" required minlength="6" autocomplete="current-password">

                        <div class="error" v-if="errorMessage">{{ errorMessage }}</div>
                        <button type="submit" class="primary-btn" :disabled="loading">{{ loading ? '登录中...' : '登录' }}</button>
                    </form>

                    <form v-else class="auth-form" @submit.prevent="handleRegister">
                        <label class="input-label">用户名</label>
                        <input class="text-input" type="text" v-model="username" required minlength="2" maxlength="20" autocomplete="username">

                        <label class="input-label">密码</label>
                        <input class="text-input" type="password" v-model="password" required minlength="6" autocomplete="new-password">

                        <label class="input-label">确认密码</label>
                        <input class="text-input" type="password" v-model="confirmPassword" required minlength="6" autocomplete="new-password">

                        <div class="error" v-if="errorMessage">{{ errorMessage }}</div>
                        <button type="submit" class="primary-btn" :disabled="loading">{{ loading ? '注册中...' : '注册' }}</button>
                    </form>
                </div>
            </div>

            <div v-else class="app-shell" key="chat">
                <aside class="nav-panel">
                    <div class="nav-header">
                        <div>
                            <div class="nav-label">Workspace</div>
                            <div class="nav-title">Lumina HQ</div>
                        </div>
                        <div class="online-pill">{{ onlineUsers.length }} 在线</div>
                    </div>

                    <div class="user-block">
                        <div class="avatar" :style="{ backgroundImage: getAvatarColor(username) }">
                            {{ initials(username) }}
                        </div>
                        <div class="user-meta">
                            <div class="user-name">{{ username }}</div>
                            <div class="user-sub">保持沟通，随时在线</div>
                        </div>
                        <button class="ghost-btn" @click="logout">退出</button>
                    </div>

                    <div class="section">
                        <div class="section-title">频道</div>
                        <div class="channel-list">
                            <button
                                v-for="channel in channels"
                                :key="channel.id"
                                class="channel-row"
                                :class="{ active: currentChannelId === channel.id }"
                                @click="switchChannel(channel.id, channel.name, channel.description)"
                            >
                                <div class="channel-meta">
                                    <span class="hash">#</span>
                                    <div>
                                        <div class="channel-name">{{ channel.name }}</div>
                                        <div class="channel-desc">{{ channel.description || '随便聊聊' }}</div>
                                    </div>
                                </div>
                                <span class="pill" v-if="channel.isDefault">默认</span>
                            </button>
                        </div>
                    </div>

                    <div class="section" v-if="availableChannels.length">
                        <div class="section-title">可加入的频道</div>
                        <div class="join-list">
                            <div class="join-row" v-for="channel in availableChannels" :key="channel.id">
                                <div>
                                    <div class="channel-name">{{ channel.name }}</div>
                                    <div class="channel-desc muted">{{ channel.description || '欢迎加入讨论' }}</div>
                                </div>
                                <button class="pill primary" @click="joinChannel(channel)">加入</button>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="chat-surface">
                    <header class="chat-header">
                        <div>
                            <div class="eyebrow">频道</div>
                            <div class="chat-title">{{ currentChannelName || '选择一个频道' }}</div>
                            <div class="chat-subtitle">
                                {{ currentChannelDescription || '从左侧选择频道开始聊天，使用 /chat 指令召唤 AI' }}
                            </div>
                        </div>
                        <div class="chat-actions">
                            <div class="soft-pill">
                                <i class="ph ph-users-three"></i>
                                <span>{{ onlineUsers.length }}</span>
                            </div>
                            <button class="icon-btn" @click="loadChannels" title="刷新频道">
                                <i class="ph ph-arrows-clockwise"></i>
                            </button>
                            <button class="icon-btn" title="搜索">
                                <i class="ph ph-magnifying-glass"></i>
                            </button>
                        </div>
                    </header>

                    <section class="message-scroll" ref="messagesContainer">
                        <div v-if="messages.length === 0" class="empty-state">
                            <div class="empty-icon"><i class="ph ph-chat-centered-dots"></i></div>
                            <div class="empty-title">这里还没有消息</div>
                            <p class="empty-subtitle">抢先发一条，打破沉默吧。</p>
                        </div>

                        <div v-for="message in messages" :key="message.id" class="message-card">
                            <div class="avatar" :style="{ backgroundImage: getAvatarColor(message.username) }">
                                {{ initials(message.username) }}
                            </div>
                            <div class="message-body">
                                <div class="message-head">
                                    <span class="message-user">{{ message.username }}</span>
                                    <span class="tag" v-if="message.messageType === 'ai'">AI</span>
                                    <span class="timestamp">{{ formatTimestamp(message.timestamp) }}</span>
                                </div>
                                <div class="message-text">{{ message.message }}</div>
                            </div>
                        </div>
                    </section>

                    <div class="typing-indicator" v-if="typingUser">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                        <span class="typing-text">{{ typingUser }} 正在输入...</span>
                    </div>

                    <footer class="composer">
                        <form class="composer-form" @submit.prevent="sendMessage">
                            <div class="input-shell">
                                <button type="button" class="icon-btn subtle" title="表情">
                                    <i class="ph ph-smiley"></i>
                                </button>
                                <input
                                    type="text"
                                    v-model="newMessage"
                                    :disabled="!currentChannelId"
                                    placeholder="输入消息，按回车发送"
                                    @input="handleTyping"
                                >
                                <button class="send-btn" type="submit" :disabled="!newMessage.trim()">
                                    发送
                                </button>
                            </div>
                        </form>
                        <div class="composer-hint">提示：输入 /chat + 问题 与 AI 对话</div>
                    </footer>
                </main>
            </div>
        </transition>
    </div>

    <script src="app.js"></script>
</body>
</html>
