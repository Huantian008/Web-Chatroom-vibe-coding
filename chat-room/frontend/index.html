<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A premium real-time multi-channel chat experience with AI.">
    <title>Lumina Chat - Multi-Channel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>
    <div id="app" v-cloak>
        <!-- Background Elements -->
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>
        <div class="bg-grid"></div>

        <!-- Login/Register Screen -->
        <transition name="fade" mode="out-in">
            <div v-if="!isLoggedIn" class="login-view" key="login">
                <div class="login-card glass-panel">
                    <div class="brand-header">
                        <div class="logo-container">
                            <i class="ph-fill ph-chat-circle-dots"></i>
                        </div>
                        <h1>Lumina Chat</h1>
                        <p>Multi-channel chat with AI</p>
                    </div>

                    <!-- Tab Switcher -->
                    <div class="auth-tabs">
                        <button class="auth-tab" :class="{ active: authMode === 'login' }" @click="authMode = 'login'">
                            ÁôªÂΩï
                        </button>
                        <button class="auth-tab" :class="{ active: authMode === 'register' }"
                            @click="authMode = 'register'">
                            Ê≥®ÂÜå
                        </button>
                    </div>

                    <!-- Login Form -->
                    <form v-if="authMode === 'login'" @submit.prevent="handleLogin" class="login-form">
                        <div class="input-wrapper">
                            <i class="ph ph-user input-icon"></i>
                            <input type="text" v-model="username" placeholder="Áî®Êà∑Âêç" required minlength="2"
                                maxlength="20" autocomplete="username">
                        </div>
                        <div class="input-wrapper">
                            <i class="ph ph-lock input-icon"></i>
                            <input type="password" v-model="password" placeholder="ÂØÜÁ†Å" required minlength="6"
                                autocomplete="current-password">
                        </div>
                        <div v-if="errorMessage" class="error-message">{{ errorMessage }}</div>
                        <button type="submit" class="primary-btn" :disabled="loading">
                            <span v-if="!loading">ÁôªÂΩï</span>
                            <span v-else>ÁôªÂΩï‰∏≠...</span>
                            <i v-if="!loading" class="ph-bold ph-arrow-right"></i>
                        </button>
                    </form>

                    <!-- Register Form -->
                    <form v-if="authMode === 'register'" @submit.prevent="handleRegister" class="login-form">
                        <div class="input-wrapper">
                            <i class="ph ph-user input-icon"></i>
                            <input type="text" v-model="username" placeholder="Áî®Êà∑Âêç (2-20‰∏™Â≠óÁ¨¶)" required minlength="2"
                                maxlength="20" autocomplete="username">
                        </div>
                        <div class="input-wrapper">
                            <i class="ph ph-lock input-icon"></i>
                            <input type="password" v-model="password" placeholder="ÂØÜÁ†Å (Ëá≥Â∞ë6‰∏™Â≠óÁ¨¶)" required minlength="6"
                                autocomplete="new-password">
                        </div>
                        <div class="input-wrapper">
                            <i class="ph ph-lock input-icon"></i>
                            <input type="password" v-model="confirmPassword" placeholder="Á°ÆËÆ§ÂØÜÁ†Å" required minlength="6"
                                autocomplete="new-password">
                        </div>
                        <div v-if="errorMessage" class="error-message">{{ errorMessage }}</div>
                        <button type="submit" class="primary-btn" :disabled="loading">
                            <span v-if="!loading">Ê≥®ÂÜå</span>
                            <span v-else>Ê≥®ÂÜå‰∏≠...</span>
                            <i v-if="!loading" class="ph-bold ph-arrow-right"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Chat Screen -->
            <div v-else class="chat-view" key="chat">
                <div class="chat-layout glass-panel">
                    <!-- Sidebar -->
                    <aside class="sidebar" :class="{ 'sidebar-open': isSidebarOpen }">
                        <div class="sidebar-header">
                            <div class="app-brand">
                                <i class="ph-fill ph-chat-circle-dots"></i>
                                <span>Lumina</span>
                            </div>
                            <button class="icon-btn mobile-close" @click="toggleSidebar">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>

                        <!-- Channel List -->
                        <div class="channels-section">
                            <div class="section-title">
                                <span>È¢ëÈÅì</span>
                                <button v-if="isAdmin" @click="showCreateChannelModal = true" class="icon-btn"
                                    title="ÂàõÂª∫È¢ëÈÅì">
                                    <i class="ph ph-plus"></i>
                                </button>
                            </div>
                            <div class="channel-list">
                                <div v-for="channel in channels" :key="channel.id" class="channel-item"
                                    :class="{ active: currentChannelId === channel.id }"
                                    @click="switchChannel(channel.id, channel.name)">
                                    <i :class="`ph ${channel.icon}`"></i>
                                    <span>{{ channel.name }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Online Users -->
                        <div class="online-users-section">
                            <div class="section-title">
                                <span>Âú®Á∫øÁî®Êà∑</span>
                                <span class="badge">{{ onlineUsers.length }}</span>
                            </div>
                            <div class="user-list">
                                <div v-for="user in onlineUsers" :key="user" class="user-card"
                                    :class="{ 'is-me': user === username }">
                                    <div class="avatar" :style="{ background: getAvatarColor(user) }">
                                        {{ user.charAt(0).toUpperCase() }}
                                        <div class="status-indicator online"></div>
                                    </div>
                                    <div class="user-info">
                                        <span class="name">
                                            {{ user }}
                                            <i v-if="isAdmin && user === username"
                                                class="ph-fill ph-shield-check admin-badge" title="ÁÆ°ÁêÜÂëò"></i>
                                        </span>
                                        <span class="status-text">{{ user === username ? '‰Ω†' : 'Âú®Á∫ø' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-footer">
                            <!-- Admin Panel Button -->
                            <button v-if="isAdmin" @click="showAdminPanel = !showAdminPanel" class="admin-toggle-btn">
                                <i class="ph ph-shield-check"></i>
                                <span>ÁÆ°ÁêÜÈù¢Êùø</span>
                            </button>
                            <button @click="logout" class="logout-btn">
                                <i class="ph ph-sign-out"></i>
                                <span>ÈÄÄÂá∫ÁôªÂΩï</span>
                            </button>
                        </div>
                    </aside>

                    <!-- Main Chat Area -->
                    <main class="chat-main">
                        <header class="chat-header">
                            <button class="icon-btn mobile-menu" @click="toggleSidebar">
                                <i class="ph ph-list"></i>
                            </button>
                            <div class="room-info">
                                <h2>
                                    <i class="ph ph-hash"></i>
                                    {{ currentChannelName || 'ÈÄâÊã©È¢ëÈÅì' }}
                                </h2>
                                <span class="status-subtitle">{{ onlineUsers.length }} ‰∫∫Âú®Á∫ø</span>
                            </div>
                            <div class="header-actions">
                                <div class="connection-status" :class="{ 'connected': isConnected }">
                                    <div class="status-dot"></div>
                                    <span>{{ isConnected ? 'Â∑≤ËøûÊé•' : 'ÈáçÊñ∞ËøûÊé•‰∏≠...' }}</span>
                                </div>
                            </div>
                        </header>

                        <!-- Mute Notification -->
                        <transition name="slide-down">
                            <div v-if="isMuted" class="mute-notification">
                                <i class="ph-fill ph-warning-circle"></i>
                                <span>{{ muteMessage }}</span>
                            </div>
                        </transition>

                        <div class="messages-scroll-area" ref="messagesContainer">
                            <div class="messages-wrapper">
                                <transition-group name="message-anim">
                                    <div v-for="msg in messages" :key="msg.id" class="message-row" :class="{
                                        'message-own': msg.username === username && msg.messageType !== 'ai',
                                        'message-system': msg.type === 'system',
                                        'message-ai': msg.messageType === 'ai'
                                    }">
                                        <div v-if="msg.type === 'system'" class="system-badge">
                                            <span>{{ msg.message }}</span>
                                        </div>

                                        <template v-else>
                                            <div class="avatar"
                                                :style="{ background: msg.messageType === 'ai' ? 'linear-gradient(135deg, #06b6d4, #0891b2)' : getAvatarColor(msg.username) }">
                                                {{ msg.messageType === 'ai' ? 'ü§ñ' : msg.username.charAt(0).toUpperCase() }}
                                            </div>
                                            <div class="message-bubble">
                                                <div class="message-meta">
                                                    <span class="sender-name">
                                                        {{ msg.username }}
                                                        <span v-if="msg.messageType === 'ai'" class="ai-tag">AI</span>
                                                    </span>
                                                    <span class="timestamp">{{ formatTime(msg.timestamp) }}</span>
                                                </div>
                                                <div class="message-content">{{ msg.message }}</div>
                                            </div>
                                        </template>
                                    </div>
                                </transition-group>

                                <div v-if="typingUser" class="typing-indicator-row">
                                    <div class="typing-bubble">
                                        <span class="typing-text">{{ typingUser }} Ê≠£Âú®ËæìÂÖ•</span>
                                        <div class="dots">
                                            <span></span><span></span><span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <div class="input-hint" v-if="!isMuted">
                                <i class="ph ph-info"></i> ÊèêÁ§∫: ËæìÂÖ• <code>/chat ‰Ω†ÁöÑÊ∂àÊÅØ</code> ‰∏éAIÂØπËØù
                            </div>
                            <form @submit.prevent="sendMessage" class="input-container">
                                <input type="text" v-model="newMessage" @input="handleTyping" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                                    class="main-input" :disabled="isMuted">
                                <button type="submit" class="send-fab" :disabled="!newMessage.trim() || isMuted">
                                    <i class="ph-fill ph-paper-plane-right"></i>
                                </button>
                            </form>
                        </div>
                    </main>

                    <!-- Mobile Overlay -->
                    <div class="sidebar-overlay" :class="{ 'active': isSidebarOpen }" @click="toggleSidebar"></div>
                </div>

                <!-- Admin Panel Modal -->
                <transition name="fade">
                    <div v-if="showAdminPanel && isAdmin" class="modal-overlay" @click="showAdminPanel = false">
                        <div class="modal-content glass-panel" @click.stop>
                            <div class="modal-header">
                                <h3><i class="ph ph-shield-check"></i> ÁÆ°ÁêÜÈù¢Êùø</h3>
                                <button @click="showAdminPanel = false" class="icon-btn">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>

                            <div class="modal-body">
                                <!-- Word Filters -->
                                <section class="admin-section">
                                    <h4>Â±èËîΩËØçÁÆ°ÁêÜ</h4>
                                    <div class="filter-input-group">
                                        <input v-model="newFilterWord" placeholder="Ê∑ªÂä†Â±èËîΩËØç" @keyup.enter="addWordFilter">
                                        <button @click="addWordFilter" class="btn-small">Ê∑ªÂä†</button>
                                    </div>
                                    <div class="filter-list">
                                        <div v-for="filter in wordFilters" :key="filter._id" class="filter-item">
                                            <span>{{ filter.word }}</span>
                                            <button @click="removeWordFilter(filter._id)" class="btn-icon-danger">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </section>

                                <!-- Global Mute -->
                                <section class="admin-section">
                                    <h4>ÂÖ®Â±ÄÁ¶ÅË®Ä</h4>
                                    <button @click="toggleGlobalMute" class="btn-toggle"
                                        :class="{ active: globalMuteEnabled }">
                                        <i :class="globalMuteEnabled ? 'ph-fill ph-speaker-slash' : 'ph ph-speaker-high'"></i>
                                        {{ globalMuteEnabled ? 'ÂÖ≥Èó≠ÂÖ®Â±ÄÁ¶ÅË®Ä' : 'ÂêØÁî®ÂÖ®Â±ÄÁ¶ÅË®Ä' }}
                                    </button>
                                </section>

                                <!-- User Management -->
                                <section class="admin-section">
                                    <h4>Áî®Êà∑ÁÆ°ÁêÜ</h4>
                                    <div class="user-management-list">
                                        <div v-for="user in allUsers" :key="user._id" class="user-mgmt-item">
                                            <div class="user-mgmt-info">
                                                <span class="user-mgmt-name">{{ user.username }}</span>
                                                <span v-if="user.isMuted" class="mute-badge">Â∑≤Á¶ÅË®Ä</span>
                                            </div>
                                            <button v-if="!user.isMuted && user.role !== 'admin'"
                                                @click="muteUser(user._id)" class="btn-small btn-danger">
                                                Á¶ÅË®Ä
                                            </button>
                                            <button v-else-if="user.isMuted" @click="unmuteUser(user._id)"
                                                class="btn-small btn-success">
                                                Ëß£Èô§
                                            </button>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- Create Channel Modal -->
                <transition name="fade">
                    <div v-if="showCreateChannelModal && isAdmin" class="modal-overlay"
                        @click="showCreateChannelModal = false">
                        <div class="modal-content glass-panel modal-small" @click.stop>
                            <div class="modal-header">
                                <h3><i class="ph ph-plus-circle"></i> ÂàõÂª∫Êñ∞È¢ëÈÅì</h3>
                                <button @click="showCreateChannelModal = false" class="icon-btn">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>

                            <div class="modal-body">
                                <form @submit.prevent="createChannel" class="channel-form">
                                    <div class="form-group">
                                        <label>È¢ëÈÅìÂêçÁß∞</label>
                                        <input v-model="newChannelName" placeholder="‰æãÂ¶Ç: ÊäÄÊúØËÆ®ËÆ∫" required>
                                    </div>
                                    <div class="form-group">
                                        <label>È¢ëÈÅìÊèèËø∞</label>
                                        <input v-model="newChannelDescription" placeholder="ÂèØÈÄâ">
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" @click="showCreateChannelModal = false"
                                            class="btn-secondary">
                                            ÂèñÊ∂à
                                        </button>
                                        <button type="submit" class="btn-primary">ÂàõÂª∫</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="app.js"></script>
</body>

</html>
